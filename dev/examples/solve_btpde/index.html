<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Solve BTPDE · SpinDoctor.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://spindoctormri.github.io/SpinDoctor.jl/examples/solve_btpde/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="SpinDoctor.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">SpinDoctor.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../getting_started/">Getting Started</a></li><li><span class="tocitem">Examples</span><ul><li class="is-active"><a class="tocitem" href>Solve BTPDE</a></li><li><a class="tocitem" href="../custom_gradient/">Custom gradients</a></li><li><a class="tocitem" href="../compute_adc/">Compare ADCs</a></li><li><a class="tocitem" href="../matrix_formalism/">Matrix Formalism</a></li><li><a class="tocitem" href="../hardi/">High Angular Resolution</a></li></ul></li><li><span class="tocitem">Theory</span><ul><li><a class="tocitem" href="../../theory/theory/">Theory</a></li><li><a class="tocitem" href="../../theory/btpde/">Bloch-Torrey PDE</a></li><li><a class="tocitem" href="../../theory/adc/">Apparent Diffusion Coefficient</a></li><li><a class="tocitem" href="../../theory/matrix_formalism/">Matrix Formalism</a></li><li><a class="tocitem" href="../../theory/discretization/">Discretization</a></li></ul></li><li><a class="tocitem" href="../../neurons/">Neurons</a></li><li><a class="tocitem" href="../../api/">API Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Solve BTPDE</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Solve BTPDE</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/SpinDoctorMRI/SpinDoctor.jl/blob/master/docs/src/examples/solve_btpde.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Solve-BTPDE"><a class="docs-heading-anchor" href="#Solve-BTPDE">Solve BTPDE</a><a id="Solve-BTPDE-1"></a><a class="docs-heading-anchor-permalink" href="#Solve-BTPDE" title="Permalink"></a></h1><p>We start by loading SpinDoctor and a Makie plotting backend.</p><pre><code class="language-julia hljs">using LinearAlgebra
using SpinDoctor
using GLMakie</code></pre><p>The built in geometry recipes allow for making various cell configuration. We here consider the case of three twisted axons immersed in an extracellular space (ECS).</p><pre><code class="language-julia hljs">setup = CylinderSetup(;
    name = &quot;some-very-real-axons&quot;,
    ncell = 3,
    rmin = 2.0,
    rmax = 6.0,
    dmin = 0.2,
    dmax = 0.3,
    height = 40.0,
    bend = 0.0,
    twist = π / 4,
    include_in = false,
    in_ratio = 0.6,
    ecs_shape = :convex_hull,
    ecs_ratio = 0.5,
)</code></pre><p>We also define coefficients for the different cell compartments <code>:in</code> (axon), <code>:out</code> (myelin), and <code>:ecs</code> (ECS).</p><pre><code class="language-julia hljs">coeffs = coefficients(
    setup;
    D = (; in = 0.002 * I(3), out = 0.002 * I(3), ecs = 0.002 * I(3)),
    T₂ = (; in = Inf, out = Inf, ecs = Inf),
    ρ = (; in = 1.0, out = 1.0, ecs = 1.0),
    κ = (; in_out = 1e-4, out_ecs = 1e-4, in = 0.0, out = 0.0, ecs = 0.0),
    γ = 2.67513e-4,
)</code></pre><p>The following line creates a random cell configuration for our cylinder setup, generates a surface triangulation and calls TetGen to create a tetrahedral finite element mesh. The compartments and boundaries will be ordered in the same way as <code>coeffs</code>.</p><pre><code class="language-julia hljs">mesh, = create_geometry(setup)</code></pre><p>The resulting mesh can be plotted in 3D provided the <code>GLMakie</code> backend is loaded.</p><pre><code class="language-julia hljs">plot_mesh(mesh)</code></pre><p><img src="../../assets/axons.png" alt="Axons"/></p><p>The mesh looks good, so we can proceed with the assembly our biological model and the associated finite element matrices.</p><pre><code class="language-julia hljs">model = Model(; mesh, coeffs...)
matrices = assemble_matrices(model)</code></pre><p>The Bloch-Torrey PDE takes a magnetic field gradient pulse sequence as an input. Here we consider a <a href="../../api/#SpinDoctor.ScalarGradient"><code>ScalarGradient</code></a> with a <a href="../../api/#SpinDoctor.PGSE"><code>PGSE</code></a> time profile.</p><pre><code class="language-julia hljs">dir = [1.0, 0.0, 0.0]
profile = PGSE(2000.0, 6000.0)
b = 1000
g = √(b / int_F²(profile)) / coeffs.γ
gradient = ScalarGradient(dir, profile, g)</code></pre><p>SpinDoctor provides a <a href="../../api/#SpinDoctor.solve"><code>solve</code></a> function, which has the same base signature for all diffusion MRI problems. The BTPDE is one such problem. They generally take a gradient sequence as an input.</p><pre><code class="language-julia hljs">btpde = BTPDE(; model, matrices)
ξ = solve(btpde, gradient)</code></pre><p>Here, <code>ξ</code> is a vector containing the complex-valued magnetization at all degrees of freedom at the echo time <code>TE</code>. We may compute the resulting signal as follows:</p><pre><code class="language-julia hljs">compute_signal(matrices.M, ξ)</code></pre><p>The global mass matrix <code>M</code> is used to compute the integral. We may however be interested in the compartment-wise signals. This requires splitting the magnetization field into the respective compartments. The compartment mass matrices are also available.</p><pre><code class="language-julia hljs">ξ_cmpts = split_field(mesh, ξ)
compute_signal.(matrices.M_cmpts, ξ_cmpts)</code></pre><p>The final magnetization can be visualized using the <a href="../../api/#SpinDoctor.plot_field"><code>plot_field</code></a> function.</p><pre><code class="language-julia hljs">plot_field(mesh, ξ)</code></pre><p><img src="../../assets/magnetization.png" alt="Magnetization"/></p><p>In this example, we have computed the complex transverse water proton magnetization field using the finite element method. The measured diffusion MRI signal is the integral of this field, and other quantities of interest, such as the apparent diffusion coefficient (ADC), or the effective diffusion tensor, may easily be obtained from this reference field. Directly solving the BTPDE is thus considered to be the &quot;gold standard&quot; for computing these quantities, as arbitrary precision may be obtained.</p><p>However, this is also often the most computationally expensive approach. In the following examples, we will consider some other specialized methods provided by SpinDoctor, each having their own domains of validity, use cases, and computational footprints.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../getting_started/">« Getting Started</a><a class="docs-footer-nextpage" href="../custom_gradient/">Custom gradients »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.14 on <span class="colophon-date" title="Saturday 12 March 2022 14:04">Saturday 12 March 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
